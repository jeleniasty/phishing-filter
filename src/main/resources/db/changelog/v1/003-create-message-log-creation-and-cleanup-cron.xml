<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
          http://www.liquibase.org/xml/ns/dbchangelog
          http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.10.xsd">

    <changeSet id="6" author="jeleniasty">
        <sql>
        <![CDATA[
            CREATE EXTENSION IF NOT EXISTS pg_cron;

        CREATE OR REPLACE FUNCTION manage_event_log_partitions() RETURNS void LANGUAGE plpgsql AS $$
        DECLARE
            r record;
            cutoff text := to_char(current_date - ${event_log_retention_days}, 'YYYY_MM_DD');
            next_day text := to_char(current_date + 1, 'YYYY_MM_DD');
            partition_name text;
            BEGIN
            FOR r IN
            SELECT tablename
            FROM pg_tables
            WHERE schemaname = 'public' AND tablename LIKE 'event_log_%'
                LOOP
                IF r.tablename < 'event_log_' || cutoff THEN
                    EXECUTE 'DROP TABLE IF EXISTS ' || quote_ident(r.tablename) || ' CASCADE';
            RAISE NOTICE 'Dropped partition: %', r.tablename;
            END IF;
            END LOOP;

            partition_name := 'event_log_' || next_day;
            IF NOT EXISTS (
                SELECT 1 FROM pg_tables
                WHERE schemaname = 'public' AND tablename = partition_name
            ) THEN
                EXECUTE format(
                    'CREATE TABLE %I PARTITION OF event_log FOR VALUES FROM (%L) TO (%L);',
                    partition_name,
                    current_date + 1,
                    current_date + 2
                );
                RAISE NOTICE 'Created partition: %', partition_name;
            END IF;
            END;
        $$;
            ]]>
        </sql>
    </changeSet>

    <changeSet id="7" author="jeleniasty">
        <sql>
            SELECT cron.schedule(
                           'manage_event_log_partitions',
                           '0 2 * * *',
                           $$SELECT manage_event_log_partitions();$$
            );
        </sql>
    </changeSet>

</databaseChangeLog>
